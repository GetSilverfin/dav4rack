<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang='en'>
  <head>
    <title>: DAV4Rack::RemoteFile [RDoc Documentation]</title>
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
    <link href='../../rdoc-style.css' media='screen' rel='stylesheet' type='text/css'>
    <script type='text/javascript'>
      //<![CDATA[
        function popupCode(url) {
          window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
        }
        
        function toggleCode(id) {
          var code = document.getElementById(id)
        
          code.style.display = code.style.display != 'block' ? 'block' : 'none'
          return true
        }
        
        // Make codeblocks hidden by default
        document.writeln('<' + 'style type="text/css">.method .source pre { display: none }<\/style>')
      //]]>
    </script>
  </head>
  <body class='page'>
    <div class='class' id='wrapper'>
      <div class='header'>
        <h1 class='name'>
          <span class='type'>Class</span>
          DAV4Rack::RemoteFile
        </h1>
        <ol class='paths'>
          <li>
            <a href="../../files/lib/dav4rack/remote_file_rb.html">lib/dav4rack/remote_file.rb</a>
          </li>
        </ol>
        <div class='parent'>
          Parent:
          <strong>Rack::File</strong>
        </div>
      </div>
      <div id='content'>
        <div id='text'>
          <div id='method-list'>
            <h2>Methods</h2>
            <h3>public class</h3>
            <ol>
              <li><a href="#M000062">new</a></li>
            </ol>
            <h3>public instance</h3>
            <ol>
              <li><a href="#M000063">call</a></li>
              <li><a href="#M000066">remote_each</a></li>
              <li><a href="#M000065">remote_serving</a></li>
              <li><a href="#M000064">sendfile_serving</a></li>
              <li><a href="#M000067">size</a></li>
            </ol>
          </div>
          <div id='section'>
            <div id='aliases-list'>
              <h2>External Aliases</h2>
              <div class='name-list'>
                <table summary='External aliases'>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>path</td>
                    <td>-&gt;</td>
                    <td class='context-item-value'>to_path</td>
                  </tr>
                </table>
              </div>
            </div>
            <div id='attribute-list'>
              <h2 class='section-bar'>Attributes</h2>
              <div class='name-list'>
                <table>
                  <tr class='top-aligned-row context-row'>
                    <td class='context-item-name'>path</td>
                    <td class='context-item-value'>[RW]</td>
                    <td class='context-item-desc'></td>
                  </tr>
                </table>
              </div>
            </div>
            <div id='methods'>
              <h2>Public class methods</h2>
              <div class='method public-class' id='method-M000062'>
                <a name='M000062'></a>
                <div class='synopsis'>
                  <span class='name'>new</span>
                  <span class='arguments'>(path, args={})</span>
                </div>
                <div class='description'>
                  <table>
                  <tr><td valign="top">path:</td><td>path to file (Actual path, preferably a URL since this is a <b>REMOTE</b>
                  file)
                  
                  </td></tr>
                  <tr><td valign="top">args:</td><td>Hash of arguments:
                  
                  <pre>:size -&gt; Integer - number of bytes&#x000A;:mime_type -&gt; String - mime type&#x000A;:last_modified -&gt; String/Time - Time of last modification&#x000A;:sendfile -&gt; True or String to define sendfile header variation&#x000A;:cache_directory -&gt; Where to store cached files&#x000A;:cache_ref -&gt; Reference to be used for cache file name (useful for changing URLs like S3)&#x000A;:sendfile_prefix -&gt; String directory prefix. Eg: 'webdav' will result in: /wedav/#{path.sub('http://', '')}&#x000A;:sendfile_fail_gracefully -&gt; Boolean if true will simply proxy if unable to determine proper sendfile</pre>
                  </td></tr>
                  </table>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000062-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000062-source'><span class="ruby-comment cmt"># File lib/dav4rack/remote_file.rb, line 24</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">path</span>, <span class="ruby-identifier">args</span>={})&#x000A;      <span class="ruby-ivar">@path</span> = <span class="ruby-identifier">path</span>&#x000A;      <span class="ruby-ivar">@args</span> = <span class="ruby-identifier">args</span>&#x000A;      <span class="ruby-ivar">@heads</span> = {}&#x000A;      <span class="ruby-ivar">@cache_file</span> = <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:cache_directory</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">cache_file_path</span> <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>&#x000A;      <span class="ruby-ivar">@redefine_prefix</span> = <span class="ruby-keyword kw">nil</span>&#x000A;      <span class="ruby-keyword kw">if</span>(<span class="ruby-ivar">@cache_file</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">exists?</span>(<span class="ruby-ivar">@cache_file</span>))&#x000A;        <span class="ruby-ivar">@root</span> = <span class="ruby-value str">''</span>&#x000A;        <span class="ruby-ivar">@path_info</span> = <span class="ruby-ivar">@cache_file</span>&#x000A;        <span class="ruby-ivar">@path</span> = <span class="ruby-ivar">@path_info</span>&#x000A;      <span class="ruby-keyword kw">elsif</span>(<span class="ruby-identifier">args</span>[<span class="ruby-identifier">:sendfile</span>])&#x000A;        <span class="ruby-ivar">@redefine_prefix</span> = <span class="ruby-value str">'sendfile'</span>&#x000A;        <span class="ruby-ivar">@sendfile_header</span> = <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:sendfile</span>].<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>) <span class="ruby-operator">?</span> <span class="ruby-identifier">args</span>[<span class="ruby-identifier">:sendfile</span>] <span class="ruby-operator">:</span> <span class="ruby-keyword kw">nil</span>&#x000A;      <span class="ruby-keyword kw">else</span>&#x000A;        <span class="ruby-identifier">setup_remote</span>&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;      <span class="ruby-identifier">do_redefines</span>(<span class="ruby-ivar">@redefine_prefix</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@redefine_prefix</span>&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <h2>Public instance methods</h2>
              <div class='method public-instance' id='method-M000063'>
                <a name='M000063'></a>
                <div class='synopsis'>
                  <span class='name'>call</span>
                  <span class='arguments'>(env)</span>
                </div>
                <div class='description'>
                  <table>
                  <tr><td valign="top">env:</td><td>Environment variable hash
                  
                  </td></tr>
                  </table>
                  <p>
                  Process the call
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000063-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000063-source'><span class="ruby-comment cmt"># File lib/dav4rack/remote_file.rb, line 45</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">call</span>(<span class="ruby-identifier">env</span>)&#x000A;      <span class="ruby-identifier">serving</span>(<span class="ruby-identifier">env</span>)&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-M000066'>
                <a name='M000066'></a>
                <div class='synopsis'>
                  <span class='name'>remote_each</span>
                  <span class='arguments'>() {|@store| ...}</span>
                </div>
                <div class='description'>
                  <p>
                  Get the remote file
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000066-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000066-source'><span class="ruby-comment cmt"># File lib/dav4rack/remote_file.rb, line 80</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">remote_each</span>&#x000A;      <span class="ruby-keyword kw">if</span>(<span class="ruby-ivar">@store</span>)&#x000A;        <span class="ruby-keyword kw">yield</span> <span class="ruby-ivar">@store</span>&#x000A;      <span class="ruby-keyword kw">else</span>&#x000A;        <span class="ruby-ivar">@con</span>.<span class="ruby-identifier">request_get</span>(<span class="ruby-ivar">@call_path</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">res</span><span class="ruby-operator">|</span>&#x000A;          <span class="ruby-identifier">res</span>.<span class="ruby-identifier">read_body</span>(<span class="ruby-ivar">@store</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">part</span><span class="ruby-operator">|</span>&#x000A;            <span class="ruby-ivar">@cf</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">part</span> <span class="ruby-keyword kw">if</span> <span class="ruby-ivar">@cf</span>&#x000A;            <span class="ruby-keyword kw">yield</span> <span class="ruby-identifier">part</span>&#x000A;          <span class="ruby-keyword kw">end</span>&#x000A;        <span class="ruby-keyword kw">end</span>&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-M000065'>
                <a name='M000065'></a>
                <div class='synopsis'>
                  <span class='name'>remote_serving</span>
                  <span class='arguments'>(e)</span>
                </div>
                <div class='description'>
                  <table>
                  <tr><td valign="top">env:</td><td>Environment variable hash
                  
                  </td></tr>
                  </table>
                  <p>
                  Return self to be processed
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000065-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000065-source'><span class="ruby-comment cmt"># File lib/dav4rack/remote_file.rb, line 71</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">remote_serving</span>(<span class="ruby-identifier">e</span>)&#x000A;      [<span class="ruby-value">200</span>, {&#x000A;             <span class="ruby-value str">&quot;Last-Modified&quot;</span>  =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">last_modified</span>,&#x000A;             <span class="ruby-value str">&quot;Content-Type&quot;</span>   =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">content_type</span>,&#x000A;             <span class="ruby-value str">&quot;Content-Length&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">size</span>&#x000A;            }, <span class="ruby-keyword kw">self</span>]&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-M000064'>
                <a name='M000064'></a>
                <div class='synopsis'>
                  <span class='name'>sendfile_serving</span>
                  <span class='arguments'>(env)</span>
                </div>
                <div class='description'>
                  <table>
                  <tr><td valign="top">env:</td><td>Environment variable hash
                  
                  </td></tr>
                  </table>
                  <p>
                  Return an empty result with the proper header information
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000064-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000064-source'><span class="ruby-comment cmt"># File lib/dav4rack/remote_file.rb, line 51</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">sendfile_serving</span>(<span class="ruby-identifier">env</span>)&#x000A;      <span class="ruby-identifier">header</span> = <span class="ruby-ivar">@sendfile_header</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">env</span>[<span class="ruby-value str">'sendfile.type'</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">env</span>[<span class="ruby-value str">'HTTP_X_SENDFILE_TYPE'</span>]&#x000A;      <span class="ruby-keyword kw">unless</span>(<span class="ruby-identifier">header</span>)&#x000A;        <span class="ruby-identifier">raise</span> <span class="ruby-value str">'Failed to determine proper sendfile header value'</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:sendfile_fail_gracefully</span>]&#x000A;        <span class="ruby-identifier">setup_remote</span>&#x000A;        <span class="ruby-identifier">do_redefines</span>(<span class="ruby-value str">'remote'</span>)&#x000A;        <span class="ruby-identifier">call</span>(<span class="ruby-identifier">env</span>)&#x000A;      <span class="ruby-keyword kw">end</span>&#x000A;      <span class="ruby-identifier">prefix</span> = (<span class="ruby-ivar">@args</span>[<span class="ruby-identifier">:sendfile_prefix</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">env</span>[<span class="ruby-value str">'HTTP_X_ACCEL_REMOTE_MAPPING'</span>]).<span class="ruby-identifier">to_s</span>.<span class="ruby-identifier">sub</span>(<span class="ruby-regexp re">/^\//</span>, <span class="ruby-value str">''</span>).<span class="ruby-identifier">sub</span>(<span class="ruby-regexp re">/\/$/</span>, <span class="ruby-value str">''</span>)&#x000A;      [<span class="ruby-value">200</span>, {&#x000A;             <span class="ruby-value str">&quot;Last-Modified&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">last_modified</span>,&#x000A;             <span class="ruby-value str">&quot;Content-Type&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">content_type</span>,&#x000A;             <span class="ruby-value str">&quot;Content-Length&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">size</span>,&#x000A;             <span class="ruby-identifier">header</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-node">&quot;/#{prefix}/#{URI.decode(@path.sub('http://', ''))}&quot;</span>&#x000A;            },&#x000A;      [<span class="ruby-value str">''</span>]]&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
              <div class='method public-instance' id='method-M000067'>
                <a name='M000067'></a>
                <div class='synopsis'>
                  <span class='name'>size</span>
                  <span class='arguments'>()</span>
                </div>
                <div class='description'>
                  <p>
                  Size based on remote headers or given size
                  </p>
                </div>
                <div class='source'>
                  <a class='source-toggle' href='#' onclick="toggleCode('M000067-source'); return false">
                    [show source]
                  </a>
                  <pre id='M000067-source'><span class="ruby-comment cmt"># File lib/dav4rack/remote_file.rb, line 94</span>&#x000A;    <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">size</span>&#x000A;      <span class="ruby-ivar">@heads</span>[<span class="ruby-value str">'content-length'</span>] <span class="ruby-operator">||</span> <span class="ruby-ivar">@size</span>&#x000A;    <span class="ruby-keyword kw">end</span></pre>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id='footer-push'></div>
    </div>
    <div id='footer'>
      <a href="http://github.com/mislav/hanna/tree/master"><strong>Hanna</strong> RDoc template</a>
    </div>
  </body>
</html>
